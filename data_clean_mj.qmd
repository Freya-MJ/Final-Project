---
title: "Data Science for Public Policy"
subtitle: "Final Project"
author: "Lezhi Cao,Mujin Li,Zehui Li,Xinwen Zhang"
execute:
  warning: false
format:
  html:
    embed-resources: true
---

## Project Proposal




## Data Description and Clean
In this project, we compiled data from various sources spanning the years 2015 to 2022, encompassing a wide array of indicators for each state. These indicators include poverty rates, population figures, median income levels, high school graduation numbers, land area, water area, and unemployment rates. To procure this diverse dataset, we employed a combination of methods, including direct web downloads and API access.

Given the heterogeneous formats of data from different sources, our data cleaning process was crucial. We harnessed tools like `pivot_longer` and `columnnames` to standardize the data format, making it amenable for merging and subsequent cleaning operations. 

After an initial examination of the data, we systematically addressed missing values by either removing variables with significant data gaps or imputing missing values with zeros. This rigorous data preparation phase ensured the integrity and consistency of our dataset, setting the stage for robust analysis and insights.

### Load the Package
```{r}
library(tidyverse)
library(tidycensus)
library(readxl)

```

### Merge the data set

```{r}
# read all the dataset
poverty_fp <- read_csv("poverty.csv")
unemployment_fp <- read_xlsx("unemploymentrateus2015-2022.xlsx")
gdp_fp <- read_xlsx("GDP.xlsx")
population_fp <- read_xlsx("Population.xlsx")
area_fp <- read_xlsx("state_area.xlsx")
income_fp <- read_xlsx("income2015-2022.xlsx")
overdose_fp <- read_excel("overdose_mortality_rate.xlsx")

## Using api retrive data of high school graduation numbers in Census Bureau from 2015-2022
census_api_key("cfab8343b6fb4bb0a3356fee1e9224c852a28e6a", install = TRUE, overwrite = TRUE)
dataneed <- load_variables(2022,"acs5",cache = TRUE)
### get every years data using the fuction
years <- c(2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022)
all_edu_data <- list()  # store in the list
for (year in years) {
  edu_data <- get_acs(geography = "state",
                      variable = c(high_school_grad_number = "B06009_003"),
                      year = year)
  edu_data$year <- year
  all_edu_data[[as.character(year)]] <- edu_data  
}
edu_fp <- bind_rows(all_edu_data)
edu_fp<- edu_fp%>%select(-moe,-variable)
colnames(edu_fp)[3] = "high_school_grad_number"
colnames(edu_fp)[2] = "state"
edu_fp <-edu_fp[-1]
```

```{r}
# merge the table one-by-one
## poverty and unemployment rate
unemployment_long <- unemployment_fp %>% pivot_longer(cols = -1, 
               names_to = "year", 
               values_to = "unemployment_rate")
pov_unemploy <- merge(poverty_fp, unemployment_long, by.x = c("year", "name"), by.y = c("year", "State"), all = TRUE)

## poverty, unemployment rate, GDP
colnames(gdp_fp)[1] = "state"
gdp_long <- gdp_fp %>% pivot_longer(cols = -1, 
               names_to = "year", 
               values_to = "gdp")
pov_unemploy_gdp <- merge(pov_unemploy, gdp_long, by.x = c("year", "name"), by.y = c("year", "state"), all = TRUE)

## poverty, unemployment rate, GDP, population
colnames(population_fp)[1]="state"
colnames(population_fp)[2:9]<-2015:2022
population_fp <-population_fp[-1,]
population_fp$state <- sub("^\\.", "", population_fp$state)
population_long <- population_fp %>% pivot_longer(cols = -1, 
               names_to = "year", 
               values_to = "population")
pov_unemploy_gdp_pop <- merge(pov_unemploy_gdp, population_long, by.x = c("year", "name"), by.y = c("year", "state"), all = TRUE)

## poverty, unemployment rate, GDP, population, income
income_long <- income_fp %>% pivot_longer(cols = -1, 
               names_to = "year", 
               values_to = "income")
pov_unemploy_gdp_pop_income <- merge(pov_unemploy_gdp_pop, income_long, by.x = c("year", "name"), by.y = c("year", "state"), all = TRUE)

## poverty, unemployment rate, GDP, population, income, area
area_fp2 <- area_fp %>%
  select(state,total_area_sq_km,land_area_sq_km,water_area_sq_km)
pov_unemploy_gdp_pop_income_area <-pov_unemploy_gdp_pop_income%>%
  left_join(area_fp2, by = c("name" = "state"))

## poverty, unemployment rate, GDP, population, income, area, high school graduation numbers
pov_unemploy_gdp_pop_income_area_edu <- merge(pov_unemploy_gdp_pop_income_area, edu_fp, by.x = c("year", "name"), by.y = c("year", "state"), all = TRUE)

## poverty, unemployment rate, GDP, population, income, area, high school graduation numbers, overdose

overdose_fp2 <- overdose_fp %>% filter(year>=2015)

# we find the overdose rate data only have state abbreviarion, we need to add the state full name in to this dataset
state <- data.frame(
  State = c(
    "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut",
    "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa",
    "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan",
    "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire",
    "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma",
    "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee",
    "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming","Distric of Columbia"
  ),
  stateid = c(
    "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA",
    "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ",
    "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT",
    "VA", "WA", "WV", "WI", "WY","DC"
  )
)
overdose_fp3 <-overdose_fp2%>%
  left_join(state, by = c("state" = "stateid"))
overdose_fp3 <-overdose_fp3[-2]
all_data <- merge(pov_unemploy_gdp_pop_income_area_edu, overdose_fp3, by.x = c("year", "name"), by.y = c("year", "State"), all = TRUE)

```

```{r}
# clean the data
## drop the useless or have to much missing value data
all_data2 <-all_data[-3]
all_data3 <-all_data2[-3]
all_data4 <- all_data3[complete.cases(all_data3$income), ]
## After checking, we find the dataset missing the data in the poverty rate in 2022
poverty_2022 <- read_xlsx("povertyrate2022.xlsx")
poverty_2022 <- poverty_2022 %>%
  mutate(year = as.character(year))
data_clean_initial <- all_data4 %>%
  left_join(poverty_2022, by = c("name" = "state", "year")) %>%
  mutate(percent_in_poverty = coalesce(percent_in_poverty.x, percent_in_poverty.y)) %>%
  select(-percent_in_poverty.x, -percent_in_poverty.y)

write.csv(data_clean_initial, file = "data_clean_mj.csv")
```

# Explotary Data Analysis 
```{r}
data <- data_clean_initial
selected_states <- c("West Virginia", "Ohio", "Delaware", "Maryland")
filtered_data <- data[data$name %in% selected_states, ]
filtered_data$year <- as.numeric(filtered_data$year)
plot_comparison <- ggplot(filtered_data, aes(x = year, y = death_rate)) +
  geom_line(size = 0.8) +
  facet_wrap(~name, ncol = 2) + 
  labs(x = "Year", 
       y = "Death Rate", 
       title = "Death Rate Trends for 4 Selected States from 2015 to 2021",
       subtitle = "The death rate means number of deaths per 100,000 total population.",
      caption = "CDC/National Center for Health Statistics") +
  theme_minimal()
plot_comparison
```





